<script lang="ts">
	import { addMovieToRadarr } from '$lib/apis/radarr/radarrApi';
	import {
		getTmdbMovie,
		getTmdbMovieRecommendations,
		getTmdbMovieSimilar
	} from '$lib/apis/tmdb/tmdbApi';
	import Button from '$lib/components/Button.svelte';
	import Card from '$lib/components/Card/Card.svelte';
	import { fetchCardTmdbProps } from '$lib/components/Card/card';
	import Carousel from '$lib/components/Carousel/Carousel.svelte';
	import CarouselPlaceholderItems from '$lib/components/Carousel/CarouselPlaceholderItems.svelte';
	import PersonCard from '$lib/components/PersonCard/PersonCard.svelte';
	import ProgressBar from '$lib/components/ProgressBar.svelte';
	import RequestModal from '$lib/components/RequestModal/RequestModal.svelte';
	import OpenInButton from '$lib/components/TitlePageLayout/OpenInButton.svelte';
	import TitlePageLayout from '$lib/components/TitlePageLayout/TitlePageLayout.svelte';
	import { removeFromRadarr, cancelDownloadRadarrMovie } from '$lib/apis/radarr/radarrApi';
	import { playerState } from '$lib/components/VideoPlayer/VideoPlayer';
	import {
		createJellyfinItemStore,
		createRadarrDownloadStore,
		createRadarrMovieStore
	} from '$lib/stores/data.store';
	import { modalStack } from '$lib/stores/modal.store';
	import { settings } from '$lib/stores/settings.store';
	import { formatMinutesToTime, formatSize } from '$lib/utils';
	import classNames from 'classnames';
	import { Archive, ChevronRight, Trash, Plus, Download } from 'radix-icons-svelte';
	import type { ComponentProps } from 'svelte';
	import { _ } from 'svelte-i18n';
	import { searchMovieRadarr } from '$lib/apis/radarr/radarrApi';
	import toast from 'svelte-french-toast';
	
	export let tmdbId: number;
	export let isModal = false;
	export let handleCloseModal: () => void = () => {};

	const tmdbUrl = 'https://www.themoviedb.org/movie/' + tmdbId;
	const data = getTmdbMovie(tmdbId);
	const recommendationData = preloadRecommendationData();

	const jellyfinItemStore = createJellyfinItemStore(tmdbId);
	const radarrMovieStore = createRadarrMovieStore(tmdbId);
	const radarrDownloadStore = createRadarrDownloadStore(radarrMovieStore);

	async function preloadRecommendationData() {
		const tmdbRecommendationProps = getTmdbMovieRecommendations(tmdbId)
			.then((r) => Promise.all(r.map(fetchCardTmdbProps)))
			.then((r) => r.filter((p) => p.backdropUrl));
		const tmdbSimilarProps = getTmdbMovieSimilar(tmdbId)
			.then((r) => Promise.all(r.map(fetchCardTmdbProps)))
			.then((r) => r.filter((p) => p.backdropUrl));

		const castPropsPromise: Promise<ComponentProps<PersonCard>[]> = data.then((m) =>
			Promise.all(
				m?.credits?.cast?.slice(0, 20).map((m) => ({
					tmdbId: m.id || 0,
					backdropUri: m.profile_path || '',
					name: m.name || '',
					subtitle: m.character || m.known_for_department || ''
				})) || []
			)
		);

		return {
			tmdbRecommendationProps: await tmdbRecommendationProps,
			tmdbSimilarProps: await tmdbSimilarProps,
			castProps: await castPropsPromise,	
		};
	}

	function play() {
		if ($jellyfinItemStore.item?.Id){
          localStorage.setItem('id', $jellyfinItemStore.item?.Id)
          playerState.streamJellyfinId($jellyfinItemStore.item?.Id);
		} 
	}

	async function refreshRadarr() {
		await radarrMovieStore.refreshIn();
	}

	let addToRadarrLoading = false;
	function addToRadarr() {
		addToRadarrLoading = true;
		addMovieToRadarr(tmdbId)
			.then(refreshRadarr)
			.finally(() => (addToRadarrLoading = false));
	}

	function openRequestModal() {
		if (!$radarrMovieStore.item?.id) return;

		modalStack.create(RequestModal, {
			radarrId: $radarrMovieStore.item?.id
		});
	}
	
	async function addMovie(){
	    if (!$radarrMovieStore.item?.id) return;
        const success = await searchMovieRadarr($radarrMovieStore.item?.id, 3);
        
        if (success) {
            await refreshRadarr();
            // Optionally, show a success message to the user
            console.log("Movie added succesfully");
        } else {
            // Optionally, show an error message to the user
            console.error("Failed to add movie");
        }
	}
	
	async function deleteMovie() {
        if (!$radarrMovieStore.item?.id) return;
        
        const confirmed = confirm("Are you sure you want to delete this movie and all associated downloads from Radarr?");
        if (!confirmed) return;

        let success = true;

        if ($radarrDownloadStore.downloads && $radarrDownloadStore.downloads.length > 0) {
            for (const download of $radarrDownloadStore.downloads) {
                if (download.id) {
                    const cancelSuccess = await cancelDownloadRadarrMovie(download.id);
                    if (!cancelSuccess) {
                        console.error(`Failed to cancel download with ID ${download.id}`);
                        success = false;
                    }
                }
            }
        }

        const removeSuccess = await removeFromRadarr($radarrMovieStore.item.id);

        if (!removeSuccess) {
            console.error("Failed to remove movie from Radarr");
            success = false;
        }

        if (success) {
            await refreshRadarr();
            console.log("Movie and associated downloads deleted successfully");
        } else {
            console.error("There were issues deleting the movie or its downloads");
        }

        // Refresh the stores
        radarrMovieStore.refreshIn();
        radarrDownloadStore.refreshIn();
    }
</script>

{#await data}
	<TitlePageLayout {isModal} {handleCloseModal} />
{:then movie }
<TitlePageLayout
    titleInformation={{
        tmdbId,
        type: 'movie',
     	title: movie?.title || 'Movie',
        logo: movie?.images?.logos?.[0]?.file_path || '',
     	posterPath: movie?.poster_path || '',
        backdropUriCandidates: movie?.images?.backdrops?.map((b) => b.file_path || '') || [],
        tagline: movie?.tagline || movie?.title || '',
        overview: movie?.overview || ''
    }}
    {isModal}
    {handleCloseModal}
>
    <svelte:fragment slot="title-info">
        {#if movie?.images?.logos?.[0]?.file_path}
            <img 
                src={`https://image.tmdb.org/t/p/w500${movie.images.logos[0].file_path}`} 
                alt="{movie?.title} logo"
                class="max-h-24 w-auto"
            />
        {:else}
            {movie?.title || 'Movie'}
        {/if}
    </svelte:fragment>

		<svelte:fragment slot="title-right">
			<div
				class="flex gap-2 items-center flex-row-reverse justify-end lg:flex-row lg:justify-start"
			>
				{#if $jellyfinItemStore.loading || $radarrMovieStore.loading}
					<div class="placeholder h-10 w-48 rounded-xl" />
				{:else}
					{@const jellyfinItem = $jellyfinItemStore.item}
					{@const radarrMovie = $radarrMovieStore.item}
					<OpenInButton title={movie?.title} {jellyfinItem} {radarrMovie} type="movie" {tmdbId} />
					{#if jellyfinItem}
						<Button type="primary" on:click={play}>
							<span>{$_('library.content.play')}</span><ChevronRight size={20} />
						</Button>
					{:else if !radarrMovie && $settings.radarr.baseUrl && $settings.radarr.apiKey}
						<Button type="primary" disabled={addToRadarrLoading} on:click={addToRadarr}>
							<span>{$_('library.content.addRadarr')}</span><Plus size={20} />
						</Button>
					{:else if radarrMovie}
    					<Button slim on:click={deleteMovie}>
    						<Trash size={25} />
    					</Button>
						<Button slim on:click={openRequestModal}>
							<span class="mr-2">Manual search... </span>
						</Button>
						{#if !$radarrDownloadStore.downloads?.length}
    						<Button type="primary" on:click={addMovie}>
     							<span class="mr-2">Add to server</span><Plus size={20} />
    						</Button>
						{/if}
						{#if $radarrDownloadStore.downloads?.length}
							{@const download = $radarrDownloadStore.downloads[0]}
							<Button type="primary">
    							<h2 class="font-medium">
    								{download?.estimatedCompletionTime
    									? formatMinutesToTime(
    											(new Date(download.estimatedCompletionTime).getTime() - Date.now()) / 1000 / 60
    									  )
    									: 'Stalled'}
    							</h2>
                                <Download  size={20}/>
    						</Button>
						{/if}
					{/if}
				{/if}
			</div>
		</svelte:fragment>

		<svelte:fragment slot="info-components">
			<div class="col-span-2 lg:col-span-1">
				<p class="text-zinc-400 text-sm">{$_('library.content.directedBy')}</p>
				<h2 class="font-medium">
					{movie?.credits.crew
						?.filter((c) => c.job == 'Director')
						.map((p) => p.name)
						.join(', ')}
				</h2>
			</div>
			<div class="col-span-2 lg:col-span-1">
				<p class="text-zinc-400 text-sm">{$_('library.content.releaseDate')}</p>
				<h2 class="font-medium">
					{new Date(movie?.release_date || Date.now()).toLocaleDateString($settings.language, {
						year: 'numeric',
						month: 'short',
						day: 'numeric'
					})}
				</h2>
			</div>
			{#if movie?.budget}
				<div class="col-span-2 lg:col-span-1">
					<p class="text-zinc-400 text-sm">{$_('library.content.budget')}</p>
					<h2 class="font-medium">
						{movie?.budget?.toLocaleString('en-US', {
							style: 'currency',
							currency: 'USD'
						})}
					</h2>
				</div>
			{/if}
			{#if movie?.revenue}
				<div class="col-span-2 lg:col-span-1">
					<p class="text-zinc-400 text-sm">{$_('library.content.revenue')}</p>
					<h2 class="font-medium">
						{movie?.revenue?.toLocaleString('en-US', {
							style: 'currency',
							currency: 'USD'
						})}
					</h2>
				</div>
			{/if}
			<div class="col-span-2 lg:col-span-1">
				<p class="text-zinc-400 text-sm">{$_('library.content.status')}</p>
				<h2 class="font-medium">
					{movie?.status}
				</h2>
			</div>
			{#if movie?.runtime}
			<div class="col-span-2 lg:col-span-1">
                <p class="text-zinc-400 text-sm">{$_('library.content.runtime')}</p>
                <h2 class="font-medium">
                    {Math.floor(movie?.runtime / 60)}h {movie?.runtime % 60}m
                </h2>
            </div>
			{/if}
		</svelte:fragment>

		<svelte:fragment slot="servarr-components">
			{@const radarrMovie = $radarrMovieStore.item}
			{#if radarrMovie}
				{#if radarrMovie?.movieFile?.quality}
					<div class="col-span-2 lg:col-span-1">
						<p class="text-zinc-400 text-sm">Video</p>
						<h2 class="font-medium">
							{radarrMovie?.movieFile?.quality.quality?.name}
						</h2>
					</div>
				{/if}
				{#if radarrMovie?.movieFile?.size}
					<div class="col-span-2 lg:col-span-1">
						<p class="text-zinc-400 text-sm">{$_('library.content.sizeDisk')}</p>
						<h2 class="font-medium">
							{formatSize(radarrMovie?.movieFile?.size || 0)}
						</h2>
					</div>
				{/if}

				<div class="flex gap-4 flex-wrap col-span-4 sm:col-span-6 mt-4">
					<Button on:click={openRequestModal}>
						<span class="mr-2">Manual search... </span>
					</Button>
					<Button slim on:click={deleteMovie}>
    						<Trash size={25} />
    				</Button>
				</div>
			{:else if $radarrMovieStore.loading}
				<div class="flex gap-4 flex-wrap col-span-4 sm:col-span-6 mt-4">
					<div class="placeholder h-10 w-40 rounded-xl" />
					<div class="placeholder h-10 w-40 rounded-xl" />
				</div>
			{/if}
		</svelte:fragment>

		<svelte:fragment slot="carousels">
			{#await recommendationData}
				<Carousel gradientFromColor="from-stone-950">
					<div slot="title" class="font-medium text-lg">{$_('library.content.castAndCrew')}</div>
					<CarouselPlaceholderItems />
				</Carousel>

				<Carousel gradientFromColor="from-stone-950">
					<div slot="title" class="font-medium text-lg">{$_('library.content.recommendations')}</div>
					<CarouselPlaceholderItems />
				</Carousel>

				<Carousel gradientFromColor="from-stone-950">
					<div slot="title" class="font-medium text-lg">{$_('library.content.similarSeries')}</div>
					<CarouselPlaceholderItems />
				</Carousel>
			{:then { castProps, tmdbRecommendationProps, tmdbSimilarProps }}
				{#if castProps?.length}
					<Carousel gradientFromColor="from-stone-950">
						<div slot="title" class="font-medium text-lg">{$_('library.content.castAndCrew')}</div>
						{#each castProps as prop}
							<PersonCard {...prop} />
						{/each}
					</Carousel>
				{/if}

				{#if tmdbRecommendationProps?.length}
					<Carousel gradientFromColor="from-stone-950">
						<div slot="title" class="font-medium text-lg">{$_('library.content.recommendations')}</div>
						{#each tmdbRecommendationProps as prop}
							<Card {...prop} openInModal={isModal} />
						{/each}
					</Carousel>
				{/if}

				{#if tmdbSimilarProps?.length}
					<Carousel gradientFromColor="from-stone-950">
						<div slot="title" class="font-medium text-lg">{$_('library.content.similarSeries')}</div>
						{#each tmdbSimilarProps as prop}
							<Card {...prop} openInModal={isModal} />
						{/each}
					</Carousel>
				{/if}
			{/await}
		</svelte:fragment>
	</TitlePageLayout>
{/await}
